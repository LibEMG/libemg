<style>
    table {
        width: 100%;
    }
</style>

This module has three main pieces of data-related functionality: **(1) Datasets**, **(2) Offline Data Handling**, and **(3) Online Data Handling**. Together, they correspond to most of the data-related functionality one would ever need for leveraging validated datasets, parsing through file structures of offline data, and processing real-time EMG.

# Datasets
To enable all interested parties the ability to leverage our library, we have included several validated datasets as part of this library. These datasets can be leveraged for exploring the library's capabilities and, additionally, for future research. We ask that for the latter, please correctly reference the dataset in your work. Note, these datasets are stored on github and will be cloned locally when downloaded. 

<details>
<summary>Show Datasets</summary>
<br/>

## Fougner

Short Description.

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | |
| **Time Per Rep:**  | |
| **Classes:**       | |
| **Device:**        | |
| **Sampling Rates:** | |
| **Continuous:**    | |
| **Repo:**          | |

**Using the Dataset:**
```Python
# TODO: Add example
```

**References:**
```
Fougner A, Scheme E, Chan AD, Englehart K, Stavdahl O. Resolving the limb position effect in myoelectric pattern recognition. IEEE Trans Neural Syst Rehabil Eng. 2011 Dec;19(6):644-51. doi: 10.1109/TNSRE.2011.2163529. Epub 2011 Aug 15. PMID: 21846608.
```

## Radmand

Short Description.

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | |
| **Time Per Rep:**  | |
| **Classes:**       | |
| **Device:**        | |
| **Sampling Rates:** | |
| **Continuous:**    | |
| **Repo:**          | |

**Using the Dataset:**
```Python
# TODO: Add example
```

**References:**
```
Radmand A, Scheme E, Englehart K. A characterization of the effect of limb position on EMG features to guide the development of effective prosthetic control schemes. Annu Int Conf IEEE Eng Med Biol Soc. 2014;2014:662-7. doi: 10.1109/EMBC.2014.6943678. PMID: 25570046.
```
-----------

## Scheme_1

Contraction Intensity.

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | |
| **Time Per Rep:**  | |
| **Classes:**       | |
| **Device:**        | |
| **Sampling Rates:** | |
| **Continuous:**    | |
| **Repo:**          | |

**Using the Dataset:**
```Python
# TODO: Add example
```

**References:**
```
Scheme E, Englehart K. Training Strategies for Mitigating the Effect of Proportional Control on Classification in Pattern Recognition Based Myoelectric Control. J Prosthet Orthot. 2013 Apr 1;25(2):76-83. doi: 10.1097/JPO.0b013e318289950b. PMID: 23894224; PMCID: PMC3719876.
```
-------------

## Scheme_2

1v1 Online.

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | |
| **Time Per Rep:**  | |
| **Classes:**       | |
| **Device:**        | |
| **Sampling Rates:** | |
| **Continuous:**    | |
| **Repo:**          | |

**Using the Dataset:**
```Python
# TODO: Add example
```

**References:**
```
E. J. Scheme and K. B. Englehart, "Validation of a Selective Ensemble-Based Classification Scheme for Myoelectric Control Using a Three-Dimensional Fitts' Law Test," in IEEE Transactions on Neural Systems and Rehabilitation Engineering, vol. 21, no. 4, pp. 616-623, July 2013, doi: 10.1109/TNSRE.2012.2226189.
```
-------------

## Scheme_3

Confidence Rejection.

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | |
| **Time Per Rep:**  | |
| **Classes:**       | |
| **Device:**        | |
| **Sampling Rates:** | |
| **Continuous:**    | |
| **Repo:**          | |

**Using the Dataset:**
```Python
# TODO: Add example
```

**References:**
```
E. J. Scheme, B. S. Hudgins and K. B. Englehart, "Confidence-Based Rejection for Improved Pattern Recognition Myoelectric Control," in IEEE Transactions on Biomedical Engineering, vol. 60, no. 6, pp. 1563-1570, June 2013, doi: 10.1109/TBME.2013.2238939.
```
-----------

## Scheme_4

Continuous Transitions.

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | |
| **Time Per Rep:**  | |
| **Classes:**       | |
| **Device:**        | |
| **Sampling Rates:** | |
| **Continuous:**    | |
| **Repo:**          | |

**Using the Dataset:**
```Python
# TODO: Add example
```

**References:**
```
E. Campbell, A. Phinyomark and E. Scheme, "Linear Discriminant Analysis with Bayesian Risk Parameters for Myoelectric Control," 2019 IEEE Global Conference on Signal and Information Processing (GlobalSIP), 2019, pp. 1-5, doi: 10.1109/GlobalSIP45357.2019.8969237.
```
-----------

## Scheme_5

Proportional Control.

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | |
| **Time Per Rep:**  | |
| **Classes:**       | |
| **Device:**        | |
| **Sampling Rates:** | |
| **Continuous:**    | |
| **Repo:**          | |

**Using the Dataset:**
```Python
# TODO: Add example
```

**References:**
```
E. Scheme, B. Lock, L. Hargrove, W. Hill, U. Kuruganti and K. Englehart, "Motion Normalized Proportional Control for Improved Pattern Recognition-Based Myoelectric Control," in IEEE Transactions on Neural Systems and Rehabilitation Engineering, vol. 22, no. 1, pp. 149-157, Jan. 2014, doi: 10.1109/TNSRE.2013.2247421.
```
----------

## Nawfel_1

Feedback.

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | |
| **Time Per Rep:**  | |
| **Classes:**       | |
| **Device:**        | |
| **Sampling Rates:** | |
| **Continuous:**    | |
| **Repo:**          | |

**Using the Dataset:**
```Python
# TODO: Add example
```

**References:**
```
J. L. Nawfel, K. B. Englehart and E. J. Scheme, "A Multi-Variate Approach to Predicting Myoelectric Control Usability," in IEEE Transactions on Neural Systems and Rehabilitation Engineering, vol. 29, pp. 1312-1327, 2021, doi: 10.1109/TNSRE.2021.3094324.
```
----------

## Robertson_1

Rejection 1.

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | |
| **Time Per Rep:**  | |
| **Classes:**       | |
| **Device:**        | |
| **Sampling Rates:** | |
| **Continuous:**    | |
| **Repo:**          | |

**Using the Dataset:**
```Python
# TODO: Add example
```

**References:**
```
Robertson JW, Englehart KB, Scheme EJ. Rejection of Systemic and Operator Errors in a Real-Time Myoelectric Control Task. Annu Int Conf IEEE Eng Med Biol Soc. 2018 Jul;2018:5640-5643. doi: 10.1109/EMBC.2018.8513529. PMID: 30441615.
```
----------

## Robertson_2

Rejection 2.

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | |
| **Time Per Rep:**  | |
| **Classes:**       | |
| **Device:**        | |
| **Sampling Rates:** | |
| **Continuous:**    | |
| **Repo:**          | |

**Using the Dataset:**
```Python
# TODO: Add example
```

**References:**
```
Robertson JW, Englehart KB, Scheme EJ. Effects of Confidence-Based Rejection on Usability and Error in Pattern Recognition-Based Myoelectric Control. IEEE J Biomed Health Inform. 2019 Sep;23(5):2002-2008. doi: 10.1109/JBHI.2018.2878907. Epub 2018 Oct 31. PMID: 30387754.
```
----------

## Raghu_1

Continuous Transitions.

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | |
| **Time Per Rep:**  | |
| **Classes:**       | |
| **Device:**        | |
| **Sampling Rates:** | |
| **Continuous:**    | |
| **Repo:**          | |

**Using the Dataset:**
```Python
# TODO: Add example
```

**References:**
```
Shriram Tallam Puranam Raghu, Dawn MacIsaac, Erik Scheme, Analyzing the impact of class transitions on the design of pattern recognition-based myoelectric control schemes, Biomedical Signal Processing and Control, Volume 71, Part A, 2022, 103134, ISSN 1746-8094, https://doi.org/10.1016/j.bspc.2021.103134.
```

## 3DCDataset

Short Description goes here. TODO: Evan

| Attribute          | Description |
| ------------------ | ----------- |
| **Num Reps:**      | 4 Training, 4 Testing       |
| **Time Per Rep:**      | 5s      |
| **Classes:**       | <ul><li>0 - No Motion</li><li>1 - Radial Deviaton</li><li>2 - Wrist Flexion</li><li>3 - Ulnar Deviaton</li><li>4 - Wrist Extension</li><li>5 - Supination</li><li>6 - Pronation</li><li>7 - Power Grip</li><li>8- Open Hand</li><li>9 - Chuck Grip</li><li>10 - Pinch Grip</li></ul>       |
| **Device:**        | Delsys        |
| **Sampling Rates:** | EMG (1000 Hz)        |
| **Continuous:**    | False |
| **Repo:**          | https://github.com/ECEEvanCampbell/3DCDataset |

**Using the Dataset:**
```Python
dataset = _3DCDataset(save_dir='3dc_data', redownload=False)
odh = dataset.prepare_data(format=OfflineDataHandler)
```

**References:**
```
@article{cote2019deep, title={Deep learning for electromyographic hand gesture signal classification using transfer learning}, author={C{^o}t{'e}-Allard, Ulysse and Fall, Cheikh Latyr and Drouin, Alexandre and Campeau-Lecours, Alexandre and Gosselin, Cl{'e}ment and Glette, Kyrre and Laviolette, Fran{\c{c}}ois and Gosselin, Benoit}, journal={IEEE transactions on neural systems and rehabilitation engineering}, volume={27}, number={4}, pages={760--771}, year={2019}, publisher={IEEE} }

@article{cote2020interpreting, title={Interpreting deep learning features for myoelectric control: A comparison with handcrafted features}, author={C{^o}t{'e}-Allard, Ulysse and Campbell, Evan and Phinyomark, Angkoon and Laviolette, Fran{\c{c}}ois and Gosselin, Benoit and Scheme, Erik}, journal={Frontiers in Bioengineering and Biotechnology}, volume={8}, pages={158}, year={2020}, publisher={Frontiers Media SA} }
```
-------------
</details>
<br/>

# Offline Data Handler 
A large overhead in projects is simply interfacing with the dataset. We are providing a means to quickly get your in-house or public datasets interfaced with the library so you can get to improving performance as fast as possible. The offline data handler is incredibly flexible with the format of the data trying to be ingested. Simply specify the base directory and it will capture all .csv and .txt files in nested folders. There can be important metadata in the file addresses that are crucial for later analysis (i.e., extracting a training set flag, subject number, repetition number, and class number from a file named `C:\User\CoolProgrammer\Dataset\training\S1_C12_R3.txt`), and we provide a simple function for defining regular expressions for all the metadata you could desire. Using these regular expressions, you can create a dictionary that you pass into the offlinedatahandler that will collect the metadata, along with the emg contents of the within the files for all files that satisfy your regexp's. If the metadata is within the file, you can alternatively hand in a column id for the metadata. Once the data handler has collected all the information available, you can use it to slice the dataset however you'd like, then proceed to feature extraction!

```Python
dataset_folder = 'demos/data/myo_dataset'
sets_values = ["training", "testing"]
sets_regex = make_regex(left_bound = "dataset/", right_bound="/", values = sets_values)
classes_values = ["0","1","2","3","4"]
classes_regex = make_regex(left_bound = "_C_", right_bound="_EMG.csv", values = classes_values)
reps_values = ["0","1","2","3"]
reps_regex = make_regex(left_bound = "R_", right_bound="_C_", values = reps_values)
dic = {
    "sets": sets_values,
    "sets_regex": sets_regex,
    "reps": reps_values,
    "reps_regex": reps_regex,
    "classes": classes_values,
    "classes_regex": classes_regex
}
odh = OfflineDataHandler()
odh.get_data(folder_location=dataset_folder, filename_dic = dic, delimiter=",")
train_odh = odh.isolate_data(key="sets", values=[1])
train_windows, train_metadata = train_odh.parse_windows(50,25)
fe = FeatureExtractor(num_channels=8)
feature_list = fe.get_feature_list()
training_features = fe.extract_features(feature_list, train_windows)
```

# Online Data Handler 
| <center>Combined</center>  | <center>All Channels</center> |
| ------------- | ------------- |
| ![alt text](all_channels.gif)  | ![alt text](multi_channel.gif)   |
<center> <p> Table 1: Raw Data from the <b>OnlineDataHandler</b></p> </center>

One of the major complications in interfacing with EMG devices is that they are all unique. The thing that they all share in common, however, is that they sample EMG at a specific frequency. To handle these differences, we have decided to abstract the device out of the library, and create a middle layer level for processing data from any device instead. In this architecture - exemplified in Figure 1 - the online data handler reads data from a UDP port. Once data is read, it is passed through the system and is processed equivalently for any hardware. 

<div>
    <img src="https://github.com/eeddy/libemg/blob/main/docs/source/documentation/data/all_channels.gif?raw=true" width="48%" display="inline-block" float="left"/>
    <img src="https://github.com/eeddy/libemg/blob/main/docs/source/documentation/data/multi_channel.gif?raw=true" width="48%" float="left"/>
</div>

![alt text](online_dh.png)
<center> <p> Figure 1: Online Data Handler Architecture</p> </center>

Streamers have been included for the following devices: `Myo Armband`, `Sifi Labs Armband`, and the `Delsys`. To leverage these streamers, look at the `utils` api. Additionally, if none of these suit your needs you can simply create your own streamer. For example, Figure 2 shows how simple this implementation is for the Myo Armband. All you must do is pickle each EMG reading as a single 1xN array, where N is the number of channels and send it over UDP. The advantage of this architecture, is that it enables our library to interface with any device at any sampling rate as long as data can be streamed over UDP. 

```Python
import socket
import multiprocessing
import pickle
from pyomyo import Myo, emg_mode

def streamer():
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    m = Myo(mode=emg_mode.FILTERED)
    m.connect()

    def write_to_socket(emg, movement):
        data_arr = pickle.dumps(list(emg))
        sock.sendto(data_arr, ('127.0.0.1' 12345))
    m.add_emg_handler(write_to_socket)
    
    while True:
        m.run()
        
if __name__ == "__main__" :
    # Create streamer in a seperate Proces:
    p = multiprocessing.Process(target=streamer, daemon=True)
    p.start()
    
    # Code leveraging the data goes here:
    odh = OnlineDataHandler(emg_arr=True, port=12345, ip='127.0.0.1')
    odh.start_listening()

    # Do stuff with data...
```
<center> <p> Figure 2: Example of an EMG Streamer for the Myo Armband</p> </center>
