<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Falling of Momo &mdash; libemg 2.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> libemg
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/introduction/introduction.html">Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/data/data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/filtering/filtering.html">Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/features/features.html">Feature Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/feature_selection/feature_selection.html">Feature Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/prediction/prediction.html">EMG Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/evaluation/evaluation.html">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/animation/animation.html">Animation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/screen_guided_training/sgt.html">Screen Guided Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/supported_hardware/supported_hardware.html">Supported Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/visualization/visualization.html">Visualizations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../emg_toolbox.html">Data Handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../emg_toolbox.html#module-libemg.datasets">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../emg_toolbox.html#module-libemg.filtering">Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../emg_toolbox.html#module-libemg.feature_extractor">Feature Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../emg_toolbox.html#module-libemg.feature_selector">Feature Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../emg_toolbox.html#module-libemg.emg_predictor">EMG Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../emg_toolbox.html#module-libemg.offline_metrics">Offline Evaluation Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../emg_toolbox.html#module-libemg.utils">Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../emg_toolbox.html#module-libemg.streamers">Streamers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../emg_toolbox.html#module-libemg.gui">Screen Guided Training</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Offline Examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../simple_offline_example/simple_offline_example.html">Simple Offline Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../features_and_group_example/features_and_group_example.html">Exploring Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../feature_optimization_example/feature_optimization_example.html">Optimizing Feature Params</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deep_learning_example/deep_learning_example.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../offline_regression_example/offline_regression_example.html">Offline Regression Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Online Examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../snake_example/snake_example.html">Continuous Control (Snake)</a></li>
<li class="toctree-l1"><a class="reference internal" href="unity_example.html">Cross Platform Control (Unity)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mouse_example/mouse_example.html">Proportional Control (Mouse Interface)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mixed_reality_example/mixed_reality_example.html">Mixed Reality (Hololens 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fitts_example/fitts_example.html">Online Evaluation (Iso Fitts)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">libemg</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>The Falling of Momo</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/libemg/libemg/blob/main/docs/source/examples/unity_example/unity.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p><a class="reference external" href="https://github.com/eeddy/Momo-Demo">View Source Code</a></p>
<p>Often, it is desirable to use tech stacks other than Python to develop applications that leverage EMG-based control. For example, Unity is a game development environment that enables high-quality games and VR/AR development, making it an intriguing tool for developing immersive environments. LibEMG was designed with this in mind and can easily interface with these differing tools. As long as the programming interface has socket functionality (C# does), it can leverage LibEMG. This example shows how to leverage the library in a simple Unity game for myoelectric training. This same concept applies to more complex applications (e.g., AR/VR) and programming languages.</p>
<section class="tex2jax_ignore mathjax_ignore" id="the-falling-of-momo">
<h1>The Falling of Momo<a class="headerlink" href="#the-falling-of-momo" title="Permalink to this heading"></a></h1>
<img alt="https://github.com/libemg/LibEMG_Unity_Showcase/blob/main/Docs/Momo_Myo.gif?raw=True" src="https://github.com/libemg/LibEMG_Unity_Showcase/blob/main/Docs/Momo_Myo.gif?raw=True" />
<p>The Falling of Momo is a simple platformer game that was designed for myoelectric training purposes <sup>[1,2]</sup>. The game’s goal is to control the character “Momo” down the screen and avoid the spikes for as long as possible. This game was originally developed in <a class="reference external" href="https://github.com/hcilab/Momo">processing</a>, but a simplified version in Unity was created for this demo. In this version, the three inputs and their respective controls are:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Game Movement</p></th>
<th class="head"><p>Keyboard</p></th>
<th class="head"><p>EMG</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Move Left</p></td>
<td><p>Left Arrow Key</p></td>
<td><p>Wrist Flexion</p></td>
</tr>
<tr class="row-odd"><td><p>Move Right</p></td>
<td><p>Right Arrow Key</p></td>
<td><p>Wrist Extension</p></td>
</tr>
<tr class="row-even"><td><p>Jump</p></td>
<td><p>Space Bar</p></td>
<td><p>Hand Closed</p></td>
</tr>
</tbody>
</table>
<p>*Note: These controls are set up for playing with the right arm.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="momo-unity-development">
<h1>Momo Unity Development<a class="headerlink" href="#momo-unity-development" title="Permalink to this heading"></a></h1>
<p>The first task was to create the Momo-Unity game. There are many great online Unity tutorials, so we won’t get into the intricate details of the game design.</p>
<div>
    <img src="https://github.com/libemg/LibEMG_Unity_Showcase/blob/main/Docs/main_menu.PNG?raw=True" width="47%"display="inline-block" float="left"/>
    <img src="https://github.com/libemg/LibEMG_Unity_Showcase/blob/main/Docs/game.PNG?raw=True" width="47%"  isplay="inline-block" float="left"/>
</div>
<p>In the initial game design, we controlled the character using the keyboard. Unity updates in a loop at a default of 60Hz in its <code class="docutils literal notranslate"><span class="pre">update</span></code> method. As displayed below in <code class="docutils literal notranslate"><span class="pre">MovementController.cs</span></code> we have created a script that listens for key events in the update method (i.e., 60 times a second) and reacts accordingly.</p>
<div class="highlight-C# notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MovementController</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">MonoBehaviour</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">upwardsForce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Rigidbody2D</span><span class="w"> </span><span class="n">rb</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">Vector2</span><span class="w"> </span><span class="n">velocity</span><span class="p">;</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">SoundManager</span><span class="w"> </span><span class="n">soundManager</span><span class="p">;</span><span class="w"> </span>

<span class="w">    </span><span class="k">void</span><span class="w"> </span><span class="nf">Start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">soundManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FindObjectOfType</span><span class="o">&lt;</span><span class="n">SoundManager</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">void</span><span class="w"> </span><span class="nf">Update</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Vector3</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rb</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">LeftArrow</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pos</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">RightArrow</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pos</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">Space</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">rb</span><span class="p">.</span><span class="n">AddForce</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">upwardsForce</span><span class="p">);</span>
<span class="w">            </span><span class="n">soundManager</span><span class="p">.</span><span class="n">PlayJumpSound</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">rb</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="momo-emg-control">
<h1>Momo EMG Control<a class="headerlink" href="#momo-emg-control" title="Permalink to this heading"></a></h1>
<p>Once the initial game worked with simple keyboard controls, we implemented the EMG-based input. Since LibEMG is developed in Python, we had to include the machine learning/training portion as a Python application. While there may be ways to call Python from within C#, this was outside the scope of this example. Instead, we created a simple UI with two buttons: <code class="docutils literal notranslate"><span class="pre">Get</span> <span class="pre">Training</span> <span class="pre">Data</span></code> and <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">Classifying</span></code>. All python code can be found in <code class="docutils literal notranslate"><span class="pre">myo_control.py</span></code>. The library imports required for this example are as follows:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">libemg.gui</span><span class="w"> </span><span class="kn">import</span> <span class="n">GUI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">libemg.data_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">OnlineDataHandler</span><span class="p">,</span> <span class="n">OfflineDataHandler</span><span class="p">,</span> <span class="n">RegexFilter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">libemg.feature_extractor</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureExtractor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">libemg.emg_predictor</span><span class="w"> </span><span class="kn">import</span> <span class="n">OnlineEMGClassifier</span><span class="p">,</span> <span class="n">EMGClassifier</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">libemg.streamers</span><span class="w"> </span><span class="kn">import</span> <span class="n">myo_streamer</span>
</pre></div>
</div>
<div>
    <img src="https://github.com/libemg/LibEMG_Unity_Showcase/blob/main/Docs/menu.PNG?raw=True" width="31%" float="left"/>
    <img src="https://github.com/libemg/LibEMG_Snake_Showcase/blob/main/docs/training_screen1.PNG?raw=True" width="31%" float="left"/>
    <img src="https://github.com/libemg/LibEMG_Snake_Showcase/blob/main/docs/training_screen2.PNG?raw=True" width="31%" float="left"/>
</div>
<p>When the <code class="docutils literal notranslate"><span class="pre">Get</span> <span class="pre">Training</span> <span class="pre">Data</span></code> button is clicked, we leverage the library’s Training UI module to automatically download the desired gestures and start the training procedure.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">launch_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
    <span class="n">training_ui</span> <span class="o">=</span> <span class="n">GUI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odh</span><span class="p">,</span> <span class="n">gesture_height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">gesture_width</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">training_ui</span><span class="o">.</span><span class="n">download_gestures</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="s2">&quot;images/&quot;</span><span class="p">)</span>
    <span class="n">training_ui</span><span class="o">.</span><span class="n">start_gui</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">initialize_ui</span><span class="p">()</span>
</pre></div>
</div>
<p>After accumulating the training data, predictions can be streamed over a UDP socket for Unity to leverage. To do this an <code class="docutils literal notranslate"><span class="pre">OnlineEMGClassifier</span></code> object is created.</p>
<p>The first step involves processing the accumulated training data into an <code class="docutils literal notranslate"><span class="pre">OfflineDataHandler</span></code>. Note that there are four classes [0,1,2,3] and three reps [0,1,2], aligning with the recorded training data.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step 1: Parse offline training data</span>
<span class="n">dataset_folder</span> <span class="o">=</span> <span class="s1">&#39;data/&#39;</span>
<span class="n">classes_values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="s2">&quot;3&quot;</span><span class="p">]</span>
<span class="n">reps_values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">]</span>
<span class="n">regex_filters</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">RegexFilter</span><span class="p">(</span><span class="n">left_bound</span> <span class="o">=</span> <span class="s2">&quot;_C_&quot;</span><span class="p">,</span> <span class="n">right_bound</span><span class="o">=</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">classes_values</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;classes&#39;</span><span class="p">),</span>
    <span class="n">RegexFilter</span><span class="p">(</span><span class="n">left_bound</span> <span class="o">=</span> <span class="s2">&quot;R_&quot;</span><span class="p">,</span> <span class="n">right_bound</span><span class="o">=</span><span class="s2">&quot;_C_&quot;</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">reps_values</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;reps&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">odh</span> <span class="o">=</span> <span class="n">OfflineDataHandler</span><span class="p">()</span>
<span class="n">odh</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">folder_location</span><span class="o">=</span><span class="n">dataset_folder</span><span class="p">,</span> <span class="n">regex_filters</span><span class="o">=</span><span class="n">regex_filters</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="n">train_windows</span><span class="p">,</span> <span class="n">train_metadata</span> <span class="o">=</span> <span class="n">odh</span><span class="o">.</span><span class="n">parse_windows</span><span class="p">(</span><span class="n">WINDOW_SIZE</span><span class="p">,</span> <span class="n">WINDOW_INCREMENT</span><span class="p">)</span>
</pre></div>
</div>
<p>The next step involves extracting features from the offline data. Let’s experiment with the LS9 feature group - a robust set of features for devices with low-sampling rates.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step 2: Extract features from offline data</span>
<span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureExtractor</span><span class="p">()</span>
<span class="n">feature_list</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">get_feature_groups</span><span class="p">()[</span><span class="s1">&#39;HTD&#39;</span><span class="p">]</span>
<span class="n">training_features</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">feature_list</span><span class="p">,</span> <span class="n">train_windows</span><span class="p">)</span>
</pre></div>
</div>
<p>After extracting the features from the training data, we have to create a dataset dictionary to pass to the online classifier.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">data_set</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">data_set</span><span class="p">[</span><span class="s1">&#39;training_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">training_features</span>
<span class="n">data_set</span><span class="p">[</span><span class="s1">&#39;training_labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_metadata</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Next, we have to create an offline EMG classifier. We have opted for an SVM model with velocity control (meaning that each prediction is associated with a contraction intensity) and two post-processing techniques: majority voting and rejection. These post-processing techniques were added to improve the robustness of the control scheme.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step 4: Create the EMG classifier</span>
<span class="n">o_classifier</span> <span class="o">=</span> <span class="n">EMGClassifier</span><span class="p">(</span><span class="s2">&quot;SVM&quot;</span><span class="p">)</span>
<span class="n">o_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">feature_dictionary</span><span class="o">=</span><span class="n">data_set</span><span class="p">)</span>
<span class="n">o_classifier</span><span class="o">.</span><span class="n">add_velocity</span><span class="p">(</span><span class="n">train_windows</span><span class="p">,</span> <span class="n">train_metadata</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Finally, lets create the <code class="docutils literal notranslate"><span class="pre">OnlineEMGClassifier</span></code> and begin streaming predictions. Note that we set block to false so that we don’t block the UI thread.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step 5: Create online EMG classifier and start classifying.</span>
<span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">OnlineEMGClassifier</span><span class="p">(</span><span class="n">o_classifier</span><span class="p">,</span> <span class="n">WINDOW_SIZE</span><span class="p">,</span> <span class="n">WINDOW_INCREMENT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">odh</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># block set to false so it will run in a seperate process.</span>
</pre></div>
</div>
<p>There is a lot to unpack in this online classifier, so let’s go through it:</p>
<ul class="simple">
<li><p><strong>model=”SVM”:</strong> In this example, we are using a Support Vector Machine for classification.</p></li>
<li><p><strong>rejection_type:</strong> Since rejection is known to improve usability, we have decided to include it.</p></li>
<li><p><strong>rejection_threshold:</strong> Since SVM is known to have a greater range of probability outputs (compared to LDA, for example), we have a much lower rejection threshold. If we set this too high, the majority of decisions will inevitably be rejected.</p></li>
<li><p><strong>majority_vote:</strong> To reduce spurious false activations (especially of the hand-closed class), we have decided to introduce a majority vote.</p></li>
<li><p><strong>velocity:</strong> Finally, we decided to leverage velocity-based control to augment the experience. This means that when users contract harder, their character will move faster. Note, that since we are leveraging velocity, ramp contractions should be acquired during the training phase.</p></li>
</ul>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="python-unity-connection">
<h1>Python-Unity Connection<a class="headerlink" href="#python-unity-connection" title="Permalink to this heading"></a></h1>
<p>Now that we have the Python side set up, we had to create a way to listen for these UDP events in C#. To do this, the <code class="docutils literal notranslate"><span class="pre">MyoEMGRawReader.cs</span></code> was created to listen on a specific port (e.g., 12346). Note that the IP and port are the default values of the OnlineEMGClassifier. Every time it receives a value, the global control and speed variable used by the <code class="docutils literal notranslate"><span class="pre">MovementControllerEMG.cs</span></code> class are updated. This receive data function runs in a separate thread to constantly listen for EMG predictions. Note that this architecture relies on <code class="docutils literal notranslate"><span class="pre">using</span> <span class="pre">System.Net.Sockets</span></code> (the C# socket implementation).</p>
<div class="highlight-C# notranslate"><div class="highlight"><pre><span></span><span class="n">String</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="kt">float</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">;</span>
<span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12346</span><span class="p">;</span>

<span class="c1">// receive thread function</span>
<span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">ReceiveData</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UdpClient</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// receive bytes</span>
<span class="w">        </span><span class="n">IPEndPoint</span><span class="w"> </span><span class="n">anyIP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IPEndPoint</span><span class="p">(</span><span class="n">IPAddress</span><span class="p">.</span><span class="n">Any</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="kt">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">buff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">Receive</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">anyIP</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// encode UTF8-coded bytes to text format</span>
<span class="w">        </span><span class="kt">string</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
<span class="w">        </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="n">parts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">text</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<span class="w">        </span><span class="n">control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">        </span><span class="n">speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">update</span></code> function in the <code class="docutils literal notranslate"><span class="pre">MovementControllerEMG.cs</span></code> the speed and control decisions are constantly read and converted to game input. There are a couple of interesting things to note here:</p>
<ul class="simple">
<li><p>We are adding a force to the object to move it left and right. This force is multiplied by the speed multiplier (i.e., the contraction intensity).</p></li>
<li><p>To reduce multiple jumps, we added a 0.5s debounced timeout. This is similar to adding debouncing to mechanical bounces to reduce activations after the fact.</p></li>
</ul>
<div class="highlight-C# notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MovementControllerEMG</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">MonoBehaviour</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">upwardsForce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Rigidbody2D</span><span class="w"> </span><span class="n">rb</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">Vector2</span><span class="w"> </span><span class="n">velocity</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">MyoEMGRawReader</span><span class="w"> </span><span class="n">emgReader</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">jumpTime</span><span class="p">;</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">SoundManager</span><span class="w"> </span><span class="n">soundManager</span><span class="p">;</span>

<span class="w">    </span><span class="k">void</span><span class="w"> </span><span class="nf">Start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">soundManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FindObjectOfType</span><span class="o">&lt;</span><span class="n">SoundManager</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">emgReader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyoEMGRawReader</span><span class="p">();</span>
<span class="w">        </span><span class="n">emgReader</span><span class="p">.</span><span class="n">StartReadingData</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">void</span><span class="w"> </span><span class="nf">FixedUpdate</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">string</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emgReader</span><span class="p">.</span><span class="n">ReadControlFromArmband</span><span class="p">();</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">movSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">emgReader</span><span class="p">.</span><span class="n">ReadSpeedFromArmband</span><span class="p">();</span>
<span class="w">        </span><span class="n">Vector3</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rb</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">control</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Debounce the jump</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Time</span><span class="p">.</span><span class="n">time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jumpTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">rb</span><span class="p">.</span><span class="n">AddForce</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">300</span><span class="p">);</span>
<span class="w">                </span><span class="n">soundManager</span><span class="p">.</span><span class="n">PlayJumpSound</span><span class="p">();</span>
<span class="w">                </span><span class="n">jumpTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="p">.</span><span class="n">time</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">control</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;2&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//Extension:</span>
<span class="w">            </span><span class="n">rb</span><span class="p">.</span><span class="n">AddForce</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Vector2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">movSpeed</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">control</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;3&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//Flexion:</span>
<span class="w">            </span><span class="n">rb</span><span class="p">.</span><span class="n">AddForce</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Vector2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">movSpeed</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">rb</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this heading"></a></h1>
<p><a id="1">[1]</a>
Aaron Tabor, Scott Bateman, Erik Scheme, David R. Flatla, and Kathrin Gerling. 2017. Designing Game-Based Myoelectric Prosthesis Training. In Proceedings of the 2017 CHI Conference on Human Factors in Computing Systems (CHI ‘17). Association for Computing Machinery, New York, NY, USA, 1352–1363. <a class="reference external" href="https://dl.acm.org/doi/10.1145/3025453.3025676">https://dl.acm.org/doi/10.1145/3025453.3025676</a></p>
<p><a id="2">[2]</a>
A. Tabor, S. Bateman and E. Scheme, “Evaluation of Myoelectric Control Learning Using Multi-Session Game-Based Training,” in IEEE Transactions on Neural Systems and Rehabilitation Engineering, vol. 26, no. 9, pp. 1680-1689, Sept. 2018, doi: 10.1109/TNSRE.2018.2855561.</p>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>